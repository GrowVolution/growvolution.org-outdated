{% extends "base.html" %}

{% block title %}Mein Wochenplan{% endblock %}

{% block style %}
    <style>
        .th-width {
            min-width: 125px;
            width: 125px;
        }
        .nowrap {
            white-space: nowrap;
        }
        .table-container {
            overflow-x: auto;
            padding-bottom: 1rem;
        }
        tbody tr {
            height: 90px;
        }
    </style>
{% endblock %}

{% block content %}
    <div class="window-wrapper px-2">
        <div class="window-box w-100" style="max-width: fit-content;">
            <div class="window-header">
                <h3 class="fw-bold mt-2">ğŸ“† Mein Wochenplan</h3>
            </div>

            <div class="window-content px-3">
                <div class="table-container">
                    <table class="table table-bordered align-middle text-center">
                        <thead class="table-light">
                        <tr>
                            {% if mode != 'simple' %}<th class="th-width"></th>{% endif %}
                            {% for label in ['Montag','Dienstag','Mittwoch','Donnerstag','Freitag','Samstag','Sonntag'] %}
                                <th class="th-width">{{ label }}</th>
                            {% endfor %}
                        </tr>
                        </thead>
                        <tbody>
                        {% if mode == 'simple' %}
                            {% set simple_labels = {
                        'laundry': 'ğŸ§º WÃ¤schetag',
                        'tidy': 'ğŸ§¹ AufrÃ¤umtag',
                        'clean': 'ğŸ§¼ Putztag',
                        'shopping': 'ğŸ›’ Einkaufstag',
                        'custom': ''
                    } %}
                            <tr>
                                {% for day in ['mo','di','mi','do','fr','sa','so'] %}
                                    <td class="text-center align-middle nowrap">
                                        {% set task = week[day] %}
                                        {% if task == 'restday' %}
                                            <span class="text-muted">Ruhetag</span>
                                        {% elif not task %}
                                            <span class="text-muted">Nicht gesetzt</span>
                                        {% else %}
                                            {% set label = simple_labels[task] if task in simple_labels else task %}
                                            <div>{{ label }}</div>
                                            {% if current_day == day %}
                                                <button class="btn btn-sm btn-success mt-2">Erledigt</button>
                                            {% endif %}
                                        {% endif %}
                                    </td>
                                {% endfor %}
                            </tr>
                        {% elif mode == 'medium' %}
                            {% set medium_labels = {
                        'sport': 'ğŸ’ªğŸ¼ Sport machen',
                        'jogging': 'ğŸƒâ€â™‚ï¸ Joggen gehen',
                        'dish': 'ğŸ½ï¸ Abwasch erledigen',
                        'laundry': 'ğŸ§º WÃ¤sche machen',
                        'meditate': 'ğŸ§˜ Meditieren',
                        'tidy': 'ğŸ§¹ AufrÃ¤umen',
                        'clean': 'ğŸ§¼ Putzen',
                        'read': 'ğŸ“– Buch lesen',
                        'learn': 'ğŸ“š Lernen',
                        'walk': 'ğŸš¶ Spazieren gehen',
                        'shop': 'ğŸ›’ Einkaufen',
                        'cook': 'ğŸ² Essen kochen',
                        'custom': ''
                    } %}
                            {% for i in range(3) %}
                                <tr>
                                    <th class="text-start">Aufgabe {{ i + 1 }}</th>
                                    {% for day in ['mo','di','mi','do','fr','sa','so'] %}
                                        {% set tasks = week[day] %}
                                        {% if tasks == 'restday' or not tasks %}
                                            {% if i == 0 %}
                                                <td rowspan="3" class="align-middle text-muted text-center">
                                                    {{ 'Ruhetag' if tasks == 'restday' else 'Nicht gesetzt' }}
                                                </td>
                                            {% endif %}
                                        {% else %}
                                            <td class="text-center align-middle">
                                                {% if i < tasks|length %}
                                                    {% set label = medium_labels[tasks[i]] if tasks[i] in medium_labels else tasks[i] %}
                                                    <div>{{ label }}</div>
                                                    {% if current_day == day %}
                                                        <div class="form-check text-start text-success mt-2">
                                                            <input class="form-check-input" type="checkbox" id="done-{{ day }}-{{ i }}">
                                                            <label class="form-check-label" for="done-{{ day }}-{{ i }}">Erledigt</label>
                                                        </div>
                                                    {% endif %}
                                                {% endif %}
                                            </td>
                                        {% endif %}
                                    {% endfor %}
                                </tr>
                            {% endfor %}
                        {% elif mode == 'free' %}
                            {% set blocks = [
                              {'label': '00â€“04', 'start': '00:00', 'end': '04:00'},
                              {'label': '04â€“08', 'start': '04:00', 'end': '08:00'},
                              {'label': '08â€“12', 'start': '08:00', 'end': '12:00'},
                              {'label': '12â€“16', 'start': '12:00', 'end': '16:00'},
                              {'label': '16â€“20', 'start': '16:00', 'end': '20:00'},
                              {'label': '20â€“24', 'start': '20:00', 'end': '23:59'}
                            ] %}
                            {%  set freq_map = {
                              'weekly': 'WÃ¶chentlich',
                              'biweekly': 'Alle 2 Wochen',
                              'triweekly': 'Alle 3 Wochen',
                              'fourweekly': 'Alle 4 Wochen'
                            } %}
                            {% for block in blocks %}
                                <tr>
                                    <th class="text-start">{{ block.label }}</th>
                                    {% for day in ['mo','di','mi','do','fr','sa','so'] %}
                                        {% set tasks = week[day] %}
                                        {% if tasks == 'restday' or not tasks %}
                                            {% if block == blocks[0] %}
                                                <td rowspan="6" class="align-middle text-muted">
                                                    {{ 'Ruhetag' if tasks == 'restday' else 'Nicht gesetzt' }}
                                                </td>
                                            {% endif %}
                                        {% else %}
                                            <td>
                                                {% for task in tasks if task.time_from_obj and block.start <= task.time_from_obj.strftime('%H:%M') < block.end %}
                                                    <div class="text-start mb-2">
                                                        <div class="fw-bold"><span class="nowrap">{{ task.title }}</span>
                                                            {% if task.start_date and current_day == day %}
                                                                <span class="fw-normal text-muted nowrap">(Start: {{ task.start_date }})</span>
                                                            {% endif %}
                                                        </div>
                                                        <div class="small text-muted">{{ task.time_from }} â€“ {{ task.time_to }} ({{ freq_map[task.frequency] }})</div>
                                                        {% if current_day == day and now >= task.time_to_obj %}
                                                            <div class="form-check mt-1">
                                                                <input class="form-check-input" type="checkbox" id="done-{{ day }}-{{ loop.index0 }}">
                                                                <label class="form-check-label" for="done-{{ day }}-{{ loop.index0 }}">Erledigt</label>
                                                            </div>
                                                        {% endif %}
                                                    </div>
                                                {% endfor %}
                                            </td>
                                        {% endif %}
                                    {% endfor %}
                                </tr>
                            {% endfor %}
                        {% endif %}
                        </tbody>
                    </table>
                </div>

                <div class="mt-3 text-center">
                    <strong>ğŸ§  Deine durchschnittliche ZuverlÃ¤ssigkeit diese Woche:</strong>
                    <div class="progress mt-2" style="height: 24px">
                        <div class="progress-bar bg-success" role="progressbar" style="width: {{ reliability or 0 }}%">
                            {{ reliability or 0 }}%
                        </div>
                    </div>

                    <a href="/week/edit" class="btn btn-outline-primary w-100 mt-3">
                        ğŸ› ï¸ Wochenplan bearbeiten
                    </a>
                </div>
            </div>
        </div>
    </div>
{% endblock %}
